# homeserver.yaml - учебный сервер для 30 студентов

# Основные настройки сервера
server_name: "matrix.local"  # Изменено с localhost на имя для локальной сети
pid_file: /data/homeserver.pid

# Публичный URL для клиентов (важно для работы из локальной сети)
public_baseurl: "http://192.168.0.7:8008/"  # Замените на IP вашего сервера в локальной сети

# Слушатели с правильной привязкой ко всем интерфейсам
listeners:
  - port: 8008
    type: http
    tls: false
    resources:
      - names: [client, federation]
        compress: false

# Настройки базы данных (SQLite подходит для 30 пользователей, но для продакшена лучше PostgreSQL)
database:
  name: sqlite3
  args:
    database: /data/homeserver.db

# Настройки регистрации
enable_registration: true
enable_registration_without_verification: true
registrations_require_3pid: []
allow_guest_access: true

# Секрет для регистрации пользователей через CLI
registration_shared_secret: "flowise_training_secret_2025"

# Полное отключение всех лимитов
rc_login:
  address:
    per_second: 10000
    burst_count: 10000
  account:
    per_second: 10000
    burst_count: 10000
  failed_attempts:
    per_second: 10000
    burst_count: 10000

rc_registration:
  per_second: 10000
  burst_count: 10000

rc_joins:
  local:
    per_second: 10000
    burst_count: 10000
  remote:
    per_second: 10000
    burst_count: 10000

rc_messages:
  per_second: 10000
  burst_count: 10000

# Отключение CAPTCHA
enable_registration_captcha: false

# Хранилище медиа
media_store_path: /data/media_store
max_upload_size: "100M"
max_image_pixels: "32M"
thumbnail_sizes:
  - width: 32
    height: 32
    method: scale
  - width: 96
    height: 96
    method: scale
  - width: 320
    height: 240
    method: scale
  - width: 640
    height: 480
    method: scale
  - width: 800
    height: 600
    method: scale

# Долгие сессии для студентов
session_lifetime: "90d"

# CORS настройки для доступа из браузера (важно для веб-клиентов)
cors:
  allowed_origin:
    - "*"  # Разрешить ВСЁ для учебного сервера в WSL2
    - "http://192.168.1.0:8008"     # Вся ваша локальная сеть
    - "http://10.0.0.0/24"        # Если сеть 10.0.0.x
    - "http://172.16.0.0/12"      # Все частные сети
    - "http://localhost:8001"     # Orchestrator
    - "http://192.168.1.100:8001" # Orchestrator по IP
    - "https://app.element.io"    # Веб-клиент Element
    - "https://element.io"        # Официальные домены
    - "http://172.18.0.0/16"      # Docker сеть внутри WSL2
  allow_credentials: true         # Разрешить аутентификацию
  max_age: 86400 

# Отключение статистики
report_stats: false

# Логирование (минимальная конфигурация)
log_config: "/data/homeserver.log.config"