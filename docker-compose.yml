services:
  # PostgreSQL Database
  postgres:
    image: postgres:15
    container_name: matrix_postgres
    restart: unless-stopped
    networks:
      - matrix-network
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=matrix_management
      - POSTGRES_USER=matrix_user
      - POSTGRES_PASSWORD=matrix_pass
    volumes:
      - postgres-data:/var/lib/postgresql/data

  # Matrix Synapse Server
  synapse:
    image: matrixdotorg/synapse:latest
    container_name: synapse
    restart: unless-stopped
    networks:
      - matrix-network
    ports:
      - "8008:8008/tcp"
    volumes:
      - synapse-data:/data
      - ./synapse/config/homeserver.yaml:/data/homeserver.yaml
      - ./synapse/config/homeserver.log.config:/data/homeserver.log.config
    environment:
      - SYNAPSE_SERVER_NAME=${SYNAPSE_SERVER_NAME}
      - SYNAPSE_REPORT_STATS=${SYNAPSE_REPORT_STATS}
      - SYNAPSE_REGISTRATION_SHARED_SECRET=${REGISTRATION_SHARED_SECRET}

  # Flowise Service
  flowise:
    image: flowiseai/flowise:latest
    container_name: flowise
    restart: unless-stopped
    networks:
      - matrix-network
    ports:
      - "3000:3000"
    volumes:
      - flowise-data:/app/data
    environment:
      - FLOWISE_USERNAME=admin
      - FLOWISE_PASSWORD=password
      - PORT=3000

  # Bot Manager Service
  bot-manager:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bot-manager
    restart: unless-stopped
    networks:
      - matrix-network
    ports:
      - "8001:8001"
    depends_on:
      - postgres
      - synapse
      - flowise
    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=postgresql://matrix_user:matrix_pass@postgres:5432/matrix_management

networks:
  matrix-network:
    driver: bridge

volumes:
  postgres-data:
  synapse-data:
  flowise-data: